<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>CDE Campus Mapper</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0d1117;
            color: #e6edf3;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .header {
            background: #161b22;
            padding: 12px 16px;
            border-bottom: 1px solid #30363d;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header h1::before {
            content: 'üìç';
        }

        .status-row {
            display: flex;
            gap: 12px;
            margin-top: 8px;
            font-size: 11px;
            color: #8b949e;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #f85149;
        }

        .dot.active { background: #3fb950; }
        .dot.warning { background: #d29922; }

        /* Map Container */
        .map-section {
            padding: 12px;
        }

        .map-container {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 12px;
            height: 300px;
            position: relative;
            overflow: hidden;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .map-overlay {
            position: absolute;
            top: 8px;
            left: 8px;
            background: rgba(0,0,0,0.8);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 11px;
            font-family: monospace;
            line-height: 1.5;
            z-index: 10;
        }

        .coord-value { color: #58a6ff; }

        /* Floor Tabs */
        .floor-tabs {
            display: flex;
            gap: 6px;
            padding: 0 12px;
            margin-bottom: 12px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .floor-tab {
            background: #21262d;
            border: 1px solid #30363d;
            color: #8b949e;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .floor-tab.active {
            background: #238636;
            border-color: #238636;
            color: #fff;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            padding: 0 12px;
            margin-bottom: 12px;
        }

        .stat-card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: #58a6ff;
            font-family: monospace;
        }

        .stat-label {
            font-size: 10px;
            color: #8b949e;
            margin-top: 4px;
            text-transform: uppercase;
        }

        /* Sensor Data Panel */
        .sensor-panel {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            margin: 0 12px 12px;
            padding: 12px;
            font-family: monospace;
            font-size: 11px;
        }

        .sensor-panel h3 {
            font-size: 12px;
            margin-bottom: 8px;
            color: #8b949e;
        }

        .sensor-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px solid #21262d;
        }

        .sensor-row:last-child { border-bottom: none; }

        .sensor-value { color: #3fb950; }

        /* Locations List */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 12px;
            margin-bottom: 8px;
        }

        .section-title {
            font-size: 12px;
            text-transform: uppercase;
            color: #8b949e;
            letter-spacing: 0.5px;
        }

        .badge {
            background: #238636;
            color: #fff;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
        }

        .locations-list {
            padding: 0 12px;
            margin-bottom: 100px;
        }

        .location-item {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .location-info h4 {
            font-size: 14px;
            margin-bottom: 4px;
        }

        .location-meta {
            font-size: 11px;
            color: #8b949e;
            font-family: monospace;
        }

        .location-type {
            font-size: 10px;
            background: #30363d;
            padding: 2px 8px;
            border-radius: 4px;
            color: #8b949e;
        }

        .delete-btn {
            background: none;
            border: none;
            color: #f85149;
            font-size: 18px;
            cursor: pointer;
            padding: 4px 8px;
        }

        .empty-state {
            text-align: center;
            padding: 30px;
            color: #8b949e;
        }

        /* Bottom Controls */
        .controls {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, #0d1117 20%);
            padding: 20px 12px 24px;
        }

        .btn-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 8px;
        }

        .btn {
            padding: 14px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .btn:active { transform: scale(0.98); }

        .btn-primary {
            background: #238636;
            color: #fff;
        }

        .btn-secondary {
            background: #21262d;
            color: #e6edf3;
            border: 1px solid #30363d;
        }

        .btn-danger {
            background: #da3633;
            color: #fff;
        }

        .btn-blue {
            background: #1f6feb;
            color: #fff;
        }

        .btn-full { grid-column: 1 / -1; }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 200;
            padding: 16px;
        }

        .modal-overlay.active { display: flex; }

        .modal {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 12px;
            padding: 20px;
            width: 100%;
            max-width: 360px;
        }

        .modal h2 {
            font-size: 16px;
            margin-bottom: 16px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-size: 12px;
            color: #8b949e;
            margin-bottom: 6px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            color: #e6edf3;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #58a6ff;
        }

        .modal-btns {
            display: flex;
            gap: 8px;
            margin-top: 20px;
        }

        .modal-btns .btn { flex: 1; }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: #30363d;
            color: #fff;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 13px;
            opacity: 0;
            transition: all 0.3s;
            z-index: 300;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* Info Banner */
        .info-banner {
            background: #1f6feb22;
            border: 1px solid #1f6feb;
            border-radius: 8px;
            padding: 12px;
            margin: 0 12px 12px;
            font-size: 12px;
            line-height: 1.5;
        }

        .info-banner strong { color: #58a6ff; }
    </style>
</head>
<body>
    <header class="header">
        <h1>CDE Campus Mapper</h1>
        <div class="status-row">
            <div class="status-item">
                <span class="dot" id="gpsDot"></span>
                <span id="gpsStatus">GPS Off</span>
            </div>
            <div class="status-item">
                <span class="dot" id="motionDot"></span>
                <span id="motionStatus">Motion Off</span>
            </div>
            <div class="status-item">
                <span id="accuracyText">--</span>
            </div>
        </div>
    </header>

    <main>
        <div class="map-section">
            <div class="map-container">
                <canvas id="map"></canvas>
                <div class="map-overlay">
                    <div>Lat: <span class="coord-value" id="latDisplay">--</span></div>
                    <div>Lng: <span class="coord-value" id="lngDisplay">--</span></div>
                    <div>Local X: <span class="coord-value" id="xDisplay">0.00</span>m</div>
                    <div>Local Y: <span class="coord-value" id="yDisplay">0.00</span>m</div>
                    <div>Floor: <span class="coord-value" id="floorDisplay">1</span></div>
                </div>
            </div>
        </div>

        <div class="floor-tabs">
            <button class="floor-tab" data-floor="-1">B1</button>
            <button class="floor-tab active" data-floor="1">L1</button>
            <button class="floor-tab" data-floor="2">L2</button>
            <button class="floor-tab" data-floor="3">L3</button>
            <button class="floor-tab" data-floor="4">L4</button>
            <button class="floor-tab" data-floor="5">L5</button>
            <button class="floor-tab" data-floor="6">L6</button>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="stepCount">0</div>
                <div class="stat-label">Steps</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="distance">0.0</div>
                <div class="stat-label">Meters</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="locationCount">0</div>
                <div class="stat-label">Marked</div>
            </div>
        </div>

        <div class="info-banner" id="infoBanner">
            <strong>üì± How to use:</strong><br>
            1. Tap <b>Start GPS</b> to track your position<br>
            2. Walk around and tap <b>Mark Location</b> at important spots<br>
            3. Use floor tabs when changing floors<br>
            4. Export JSON when done
        </div>

        <div class="sensor-panel" id="sensorPanel" style="display: none;">
            <h3>üìä Sensor Debug</h3>
            <div class="sensor-row">
                <span>Accel X/Y/Z</span>
                <span class="sensor-value" id="accelData">-- / -- / --</span>
            </div>
            <div class="sensor-row">
                <span>Heading</span>
                <span class="sensor-value" id="headingData">--¬∞</span>
            </div>
            <div class="sensor-row">
                <span>GPS Accuracy</span>
                <span class="sensor-value" id="gpsAccuracy">--m</span>
            </div>
            <div class="sensor-row">
                <span>Last Update</span>
                <span class="sensor-value" id="lastUpdate">--</span>
            </div>
        </div>

        <div class="section-header">
            <span class="section-title">Marked Locations</span>
            <span class="badge" id="markedCount">0</span>
        </div>

        <div class="locations-list" id="locationsList">
            <div class="empty-state">
                No locations marked yet.<br>
                Start tracking and mark points as you walk!
            </div>
        </div>
    </main>

    <div class="controls">
        <div class="btn-row">
            <button class="btn btn-primary btn-full" id="gpsBtn" onclick="toggleGPS()">
                üì° Start GPS Tracking
            </button>
        </div>
        <div class="btn-row">
            <button class="btn btn-blue" id="markBtn" onclick="openMarkModal()" disabled>
                üìç Mark Location
            </button>
            <button class="btn btn-secondary" onclick="toggleSensorPanel()">
                üîß Debug
            </button>
        </div>
        <div class="btn-row">
            <button class="btn btn-secondary" onclick="resetOrigin()">
                ‚Üª Reset Origin
            </button>
            <button class="btn btn-primary" onclick="exportData()">
                üíæ Export JSON
            </button>
        </div>
    </div>

    <!-- Mark Location Modal -->
    <div class="modal-overlay" id="markModal">
        <div class="modal">
            <h2>üìç Mark This Location</h2>
            <div class="form-group">
                <label>Location Name / Room Code</label>
                <input type="text" id="locName" placeholder="e.g., E1A-03-01, Main Lobby">
            </div>
            <div class="form-group">
                <label>Type</label>
                <select id="locType">
                    <option value="room">Room / Lecture Hall</option>
                    <option value="junction">Corridor Junction</option>
                    <option value="stairs">Staircase</option>
                    <option value="lift">Lift / Elevator</option>
                    <option value="entrance">Entrance / Exit</option>
                    <option value="amenity">Amenity (Toilet, etc.)</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label>Aliases (comma separated)</label>
                <input type="text" id="locAliases" placeholder="e.g., LT1, lecture theatre">
            </div>
            <div class="modal-btns">
                <button class="btn btn-secondary" onclick="closeMarkModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveLocation()">Save</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // ============ STATE ============
        const state = {
            gpsActive: false,
            watchId: null,
            currentPos: { lat: null, lng: null, accuracy: null },
            originPos: { lat: null, lng: null }, // Reference point for local coords
            localPos: { x: 0, y: 0 },
            currentFloor: 1,
            stepCount: 0,
            distance: 0,
            locations: [],
            pathHistory: [],
            motionActive: false,
            lastAccel: { x: 0, y: 0, z: 0 },
            heading: 0,
        };

        // ============ DOM ============
        const $ = id => document.getElementById(id);

        // ============ GPS ============
        function toggleGPS() {
            if (state.gpsActive) {
                stopGPS();
            } else {
                startGPS();
            }
        }

        function startGPS() {
            if (!navigator.geolocation) {
                toast('GPS not supported on this device');
                return;
            }

            $('gpsBtn').textContent = '‚è≥ Getting GPS...';
            $('gpsBtn').disabled = true;

            // Request permission and start watching
            state.watchId = navigator.geolocation.watchPosition(
                onGPSSuccess,
                onGPSError,
                {
                    enableHighAccuracy: true,
                    maximumAge: 0,
                    timeout: 10000
                }
            );
        }

        function onGPSSuccess(position) {
            const { latitude, longitude, accuracy, heading } = position.coords;
            
            state.currentPos = { lat: latitude, lng: longitude, accuracy };
            state.gpsActive = true;

            // Set origin on first fix
            if (!state.originPos.lat) {
                state.originPos = { lat: latitude, lng: longitude };
                toast('Origin set! Position tracking started.');
            }

            // Calculate local coordinates (meters from origin)
            const local = gpsToLocal(latitude, longitude);
            state.localPos = local;

            // Update UI
            $('gpsDot').classList.add('active');
            $('gpsStatus').textContent = 'GPS Active';
            $('gpsBtn').textContent = '‚èπ Stop GPS';
            $('gpsBtn').disabled = false;
            $('gpsBtn').classList.remove('btn-primary');
            $('gpsBtn').classList.add('btn-danger');
            $('markBtn').disabled = false;

            $('latDisplay').textContent = latitude.toFixed(6);
            $('lngDisplay').textContent = longitude.toFixed(6);
            $('xDisplay').textContent = local.x.toFixed(2);
            $('yDisplay').textContent = local.y.toFixed(2);
            $('gpsAccuracy').textContent = accuracy.toFixed(1) + 'm';
            $('accuracyText').textContent = `¬±${accuracy.toFixed(0)}m`;
            $('lastUpdate').textContent = new Date().toLocaleTimeString();

            // Record path
            state.pathHistory.push({
                lat: latitude,
                lng: longitude,
                x: local.x,
                y: local.y,
                floor: state.currentFloor,
                time: Date.now()
            });

            // Calculate distance from last point
            if (state.pathHistory.length > 1) {
                const prev = state.pathHistory[state.pathHistory.length - 2];
                const dist = Math.sqrt(
                    Math.pow(local.x - prev.x, 2) + 
                    Math.pow(local.y - prev.y, 2)
                );
                if (dist > 0.5 && dist < 50) { // Filter noise
                    state.distance += dist;
                    $('distance').textContent = state.distance.toFixed(1);
                }
            }

            renderMap();
        }

        function onGPSError(error) {
            console.error('GPS Error:', error);
            $('gpsDot').classList.remove('active');
            $('gpsDot').classList.add('warning');
            $('gpsStatus').textContent = 'GPS Error';
            $('gpsBtn').textContent = 'üì° Start GPS';
            $('gpsBtn').disabled = false;
            $('gpsBtn').classList.add('btn-primary');
            $('gpsBtn').classList.remove('btn-danger');

            let msg = 'GPS error: ';
            switch(error.code) {
                case 1: msg += 'Permission denied. Please allow location access.'; break;
                case 2: msg += 'Position unavailable. Try moving outdoors.'; break;
                case 3: msg += 'Timeout. Retrying...'; break;
            }
            toast(msg);
        }

        function stopGPS() {
            if (state.watchId) {
                navigator.geolocation.clearWatch(state.watchId);
                state.watchId = null;
            }
            state.gpsActive = false;
            
            $('gpsDot').classList.remove('active');
            $('gpsStatus').textContent = 'GPS Off';
            $('gpsBtn').textContent = 'üì° Start GPS';
            $('gpsBtn').classList.add('btn-primary');
            $('gpsBtn').classList.remove('btn-danger');
            $('markBtn').disabled = true;
            
            toast('GPS tracking stopped');
        }

        // Convert GPS to local meters (simple approximation)
        function gpsToLocal(lat, lng) {
            if (!state.originPos.lat) return { x: 0, y: 0 };
            
            // 1 degree latitude ‚âà 111,320m
            // 1 degree longitude ‚âà 111,320m * cos(lat)
            const latDiff = lat - state.originPos.lat;
            const lngDiff = lng - state.originPos.lng;
            
            const y = latDiff * 111320;
            const x = lngDiff * 111320 * Math.cos(state.originPos.lat * Math.PI / 180);
            
            return { x, y };
        }

        function resetOrigin() {
            if (state.currentPos.lat) {
                state.originPos = { 
                    lat: state.currentPos.lat, 
                    lng: state.currentPos.lng 
                };
                state.localPos = { x: 0, y: 0 };
                state.pathHistory = [];
                state.distance = 0;
                $('distance').textContent = '0.0';
                $('xDisplay').textContent = '0.00';
                $('yDisplay').textContent = '0.00';
                renderMap();
                toast('Origin reset to current position');
            } else {
                toast('Start GPS first to reset origin');
            }
        }

        // ============ MOTION SENSORS ============
        async function initMotionSensors() {
            // Try to enable motion sensors
            if (typeof DeviceMotionEvent !== 'undefined') {
                if (typeof DeviceMotionEvent.requestPermission === 'function') {
                    // iOS 13+
                    try {
                        const permission = await DeviceMotionEvent.requestPermission();
                        if (permission === 'granted') {
                            enableMotion();
                        }
                    } catch (e) {
                        console.log('Motion permission error:', e);
                    }
                } else {
                    // Android / older iOS
                    enableMotion();
                }
            }

            if (typeof DeviceOrientationEvent !== 'undefined') {
                if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                    try {
                        const permission = await DeviceOrientationEvent.requestPermission();
                        if (permission === 'granted') {
                            enableOrientation();
                        }
                    } catch (e) {
                        console.log('Orientation permission error:', e);
                    }
                } else {
                    enableOrientation();
                }
            }
        }

        function enableMotion() {
            window.addEventListener('devicemotion', (e) => {
                const a = e.accelerationIncludingGravity;
                if (a && a.x !== null) {
                    state.lastAccel = { x: a.x, y: a.y, z: a.z };
                    state.motionActive = true;
                    $('motionDot').classList.add('active');
                    $('motionStatus').textContent = 'Motion OK';
                    $('accelData').textContent = 
                        `${a.x?.toFixed(1)} / ${a.y?.toFixed(1)} / ${a.z?.toFixed(1)}`;
                    
                    // Simple step detection
                    detectStep(a);
                }
            });
        }

        function enableOrientation() {
            window.addEventListener('deviceorientation', (e) => {
                if (e.alpha !== null) {
                    state.heading = e.alpha;
                    $('headingData').textContent = e.alpha.toFixed(0) + '¬∞';
                }
            });
        }

        // Simple step detection
        let lastMag = 9.8;
        let lastStepTime = 0;
        
        function detectStep(a) {
            const mag = Math.sqrt(a.x*a.x + a.y*a.y + a.z*a.z);
            const now = Date.now();
            
            // Peak detection with cooldown
            if (mag > 11 && lastMag <= 11 && now - lastStepTime > 300) {
                state.stepCount++;
                lastStepTime = now;
                $('stepCount').textContent = state.stepCount;
            }
            lastMag = mag;
        }

        // ============ MAP RENDERING ============
        function renderMap() {
            const canvas = $('map');
            const ctx = canvas.getContext('2d');
            
            // Set canvas size
            canvas.width = canvas.parentElement.clientWidth;
            canvas.height = canvas.parentElement.clientHeight;
            
            const w = canvas.width;
            const h = canvas.height;
            const cx = w / 2;
            const cy = h / 2;
            const scale = 3; // pixels per meter

            // Clear
            ctx.fillStyle = '#161b22';
            ctx.fillRect(0, 0, w, h);

            // Grid
            ctx.strokeStyle = '#30363d';
            ctx.lineWidth = 1;
            for (let x = 0; x < w; x += 30) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, h);
                ctx.stroke();
            }
            for (let y = 0; y < h; y += 30) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(w, y);
                ctx.stroke();
            }

            // Path
            const floorPath = state.pathHistory.filter(p => p.floor === state.currentFloor);
            if (floorPath.length > 1) {
                ctx.strokeStyle = '#8b5cf6';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(cx + floorPath[0].x * scale, cy - floorPath[0].y * scale);
                floorPath.forEach(p => {
                    ctx.lineTo(cx + p.x * scale, cy - p.y * scale);
                });
                ctx.stroke();
            }

            // Location markers
            const floorLocs = state.locations.filter(l => l.floor === state.currentFloor);
            floorLocs.forEach(loc => {
                const px = cx + loc.x * scale;
                const py = cy - loc.y * scale;

                ctx.fillStyle = '#3fb950';
                ctx.beginPath();
                ctx.arc(px, py, 6, 0, Math.PI * 2);
                ctx.fill();

                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                ctx.stroke();

                // Label
                ctx.fillStyle = '#fff';
                ctx.font = '10px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(loc.name.slice(0, 12), px, py + 16);
            });

            // Current position
            const px = cx + state.localPos.x * scale;
            const py = cy - state.localPos.y * scale;

            ctx.fillStyle = '#58a6ff';
            ctx.beginPath();
            ctx.arc(px, py, 8, 0, Math.PI * 2);
            ctx.fill();

            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 2;
            ctx.stroke();

            // Direction indicator
            if (state.heading) {
                const rad = (state.heading - 90) * Math.PI / 180;
                ctx.strokeStyle = '#58a6ff';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(px, py);
                ctx.lineTo(px + Math.cos(rad) * 20, py + Math.sin(rad) * 20);
                ctx.stroke();
            }
        }

        // ============ LOCATIONS ============
        function openMarkModal() {
            $('markModal').classList.add('active');
            $('locName').focus();
        }

        function closeMarkModal() {
            $('markModal').classList.remove('active');
            $('locName').value = '';
            $('locAliases').value = '';
        }

        function saveLocation() {
            const name = $('locName').value.trim();
            if (!name) {
                toast('Please enter a name');
                return;
            }

            const loc = {
                id: `L${state.currentFloor}-${Date.now()}`,
                name: name,
                type: $('locType').value,
                aliases: $('locAliases').value.split(',').map(s => s.trim()).filter(Boolean),
                lat: state.currentPos.lat,
                lng: state.currentPos.lng,
                x: state.localPos.x,
                y: state.localPos.y,
                floor: state.currentFloor,
                accuracy: state.currentPos.accuracy,
                timestamp: Date.now()
            };

            state.locations.push(loc);
            closeMarkModal();
            updateLocationsList();
            renderMap();
            saveToStorage();
            toast(`"${name}" saved!`);
        }

        function updateLocationsList() {
            const list = $('locationsList');
            $('markedCount').textContent = state.locations.length;
            $('locationCount').textContent = state.locations.length;

            if (state.locations.length === 0) {
                list.innerHTML = `<div class="empty-state">
                    No locations marked yet.<br>
                    Start tracking and mark points as you walk!
                </div>`;
                return;
            }

            list.innerHTML = state.locations.map((loc, i) => `
                <div class="location-item">
                    <div class="location-info">
                        <h4>${loc.name}</h4>
                        <div class="location-meta">
                            Floor ${loc.floor} | X:${loc.x.toFixed(1)} Y:${loc.y.toFixed(1)}
                        </div>
                    </div>
                    <div style="display:flex;align-items:center;gap:8px;">
                        <span class="location-type">${loc.type}</span>
                        <button class="delete-btn" onclick="deleteLocation(${i})">√ó</button>
                    </div>
                </div>
            `).join('');
        }

        function deleteLocation(index) {
            state.locations.splice(index, 1);
            updateLocationsList();
            renderMap();
            saveToStorage();
            toast('Location deleted');
        }

        // ============ FLOOR TABS ============
        document.querySelectorAll('.floor-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.floor-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                state.currentFloor = parseInt(tab.dataset.floor);
                $('floorDisplay').textContent = state.currentFloor;
                renderMap();
            });
        });

        // ============ STORAGE ============
        function saveToStorage() {
            localStorage.setItem('cdeMapper', JSON.stringify({
                locations: state.locations,
                originPos: state.originPos
            }));
        }

        function loadFromStorage() {
            const saved = localStorage.getItem('cdeMapper');
            if (saved) {
                const data = JSON.parse(saved);
                state.locations = data.locations || [];
                if (data.originPos) state.originPos = data.originPos;
                updateLocationsList();
            }
        }

        // ============ EXPORT ============
        function exportData() {
            const data = {
                metadata: {
                    building: "CDE",
                    exportDate: new Date().toISOString(),
                    origin: state.originPos,
                    totalLocations: state.locations.length
                },
                nodes: {},
                floors: {}
            };

            // Group by floor
            state.locations.forEach(loc => {
                const nodeId = `L${loc.floor}-${loc.type.toUpperCase()}-${loc.name.replace(/\W/g, '')}`;
                
                if (!data.floors[loc.floor]) {
                    data.floors[loc.floor] = { name: `Level ${loc.floor}`, nodes: {} };
                }

                const node = {
                    name: loc.name,
                    type: loc.type,
                    aliases: loc.aliases,
                    coordinates: { x: loc.x, y: loc.y },
                    gps: { lat: loc.lat, lng: loc.lng },
                    connections: []
                };

                data.nodes[nodeId] = { ...node, floor: loc.floor };
                data.floors[loc.floor].nodes[nodeId] = node;
            });

            // Auto-detect connections (nodes within 30m on same floor)
            const nodeIds = Object.keys(data.nodes);
            nodeIds.forEach(id1 => {
                nodeIds.forEach(id2 => {
                    if (id1 >= id2) return;
                    const n1 = data.nodes[id1];
                    const n2 = data.nodes[id2];
                    if (n1.floor !== n2.floor) return;

                    const dist = Math.sqrt(
                        Math.pow(n1.coordinates.x - n2.coordinates.x, 2) +
                        Math.pow(n1.coordinates.y - n2.coordinates.y, 2)
                    );

                    if (dist < 30) {
                        n1.connections.push({ to: id2, distance: dist.toFixed(2) });
                        n2.connections.push({ to: id1, distance: dist.toFixed(2) });
                    }
                });
            });

            // Download
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `cde-map-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);

            toast('Map data exported!');
        }

        // ============ UI HELPERS ============
        function toggleSensorPanel() {
            const panel = $('sensorPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        function toast(msg) {
            const t = $('toast');
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        // ============ INIT ============
        function init() {
            loadFromStorage();
            renderMap();
            initMotionSensors();
            
            // Handle resize
            window.addEventListener('resize', renderMap);
        }

        init();
    </script>
</body>
</html>
